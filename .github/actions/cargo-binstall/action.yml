name: Install tools with cargo-binstall

inputs:
  package-specs:
    required: true

runs:
  using: composite
  steps:
    - name: Install Bash
      run: brew install bash
      if: runner.os == 'macOS'

    - run: bash --version

    - name: Install cargo-binstall *
      run: |
        BIN_DIR=/tmp/cargo-binstall
        case "$OS" in
          Windows)
            URL_SUFFIX=x86_64-pc-windows-msvc.zip
            EXE_SUFFIX=.exe;;
          macOS)
            URL_SUFFIX=x86_64-apple-darwin.zip
            EXE_SUFFIX=;;
          Linux)
            URL_SUFFIX=x86_64-unknown-linux-musl.tgz
            EXE_SUFFIX=;;
        esac
        URL="https://github.com/ryankurte/cargo-binstall/releases/latest/download/cargo-binstall-$URL_SUFFIX"
        ARCHIVE_EXT="${URL##*.}"
        ARCHIVE_PATH="/tmp/cargo-binstall.$ARCHIVE_EXT"

        mkdir -p "$BIN_DIR"
        curl --proto =https --tlsv1.2 -fL --retry 10 --retry-connrefused "$URL" -o "$ARCHIVE_PATH"
        case "$ARCHIVE_EXT" in
          zip) 7z x "$ARCHIVE_PATH" "-o$BIN_DIR";;
          tgz) tar xvf "$ARCHIVE_PATH" -C "$BIN_DIR";;
        esac
        rm "$ARCHIVE_PATH"
        echo "Installed $BIN_DIR/cargo-binstall$EXE_SUFFIX" >&2
        echo "$BIN_DIR" >>"$GITHUB_PATH"
        ls -l "$BIN_DIR"
      shell: bash
      env:
        OS: ${{ runner.os }}

    - run: >
        tr : '\n' <<<"$PATH"
      shell: bash

    - name: Run cargo-binstall
      run: |
        mapfile -td , package_specs <<<"$PACKAGE_SPECS,"
        unset 'package_specs[-1]'
        for spec in "${package_specs[@]}"; do
          printf 'Installing `%s`\n' "$spec" >&2
          cargo binstall "${spec%@*}" --version "${spec#*@}" --no-confirm
        done
      shell: bash
      env:
        PACKAGE_SPECS: ${{ inputs.package-specs }}
